<project name="Aliwal Geocoder All Arches Build" default="all" basedir="../">
	
	<property file="build/build.properties"/>
		
	<description>
		Mulitple architecture Build process for ${NAME.SHORT}
	</description>
	
	<target name="patch_number">
		<!-- 
			Thanks: http://blog.nirav.name/2008/02/how-to-auto-increament-version-build-id.html
		-->
		<propertyfile file="build/build.properties" comment="VERSION.PATCH incremented by ANT build. Edit not!">
			<entry key="VERSION.PATCH" type="int" operation="+" default="1" />
		</propertyfile>
	</target>
	
	<target name="all" depends="patch_number,dist_osx,dist_win32" description="Build everything. " />
	
	
<!-- ******************** WIN32 BUILD **************************************************************** -->	
		
		<property name="WIN32.NAME.ARCH" 	value="${NAME.SHORT}.exe" />		
		<property name="WIN32.BASE.DIR" 	location="build/win" />
		<property name="WIN32.LIB.DIR"        location="build/win/lib"            />
			
		<property name="WIN32.BUILD.DIR" 	location="build/win/tmp.build/${NAME.SHORT}" />
		
		<property name="WIN32.DIST.DIR"       location="build/win/dist" />

		
		
		
		<target name="clean_dist_win32" description="Clean up for dist target">
			<delete dir="${WIN32.DIST.DIR}"  />
		</target>
			
		<target name="clean_compile_win32" description="Clean up for compile target">
			<delete dir="${WIN32.BUILD.DIR}" 	/>
		</target>
			
		<target name="clean_win32" description="clean up" 
			depends="clean_dist_win32,clean_compile_win32">		
		</target>
		
		<target name="init_win32" depends="">
			<!-- Create the time stamp -->
			<tstamp/>
			<mkdir dir="${WIN32.BUILD.DIR}"      />					
			<tar tarfile="${WIN32.BUILD.DIR}/lib.tar" basedir="${WIN32.LIB.DIR}/" longfile="gnu" />
			<untar src="${WIN32.BUILD.DIR}/lib.tar"   dest="${WIN32.BUILD.DIR}" overwrite="true" />
			<delete file="${WIN32.BUILD.DIR}/lib.tar" />
			
			<mkdir dir="${WIN32.DIST.DIR}" />
		</target>

		<target name="compile_win32" depends="clean_compile_win32,init_win32"
			description="copy across the application" >
			<copy todir="${WIN32.BUILD.DIR}" preservelastmodified="true">
				<fileset dir="${SRC.DIR}" >
					<include name="**/*" />
					<exclude name="**.svn" />
					<exclude name=".project" />
				</fileset>
			</copy>
			<echo>Need to sort out the icon. CMDline Resource editor ?</echo>
			<copy file="${WIN32.BUILD.DIR}\xulrunner\xulrunner-stub.exe" tofile="${WIN32.BUILD.DIR}\${WIN32.NAME.ARCH}" />

		</target>
		
		<target name="dist_win32" depends="clean_dist_win32,compile_win32"
			description="generate the distribution" >
			

			<exec executable="c:\Program Files\NSIS\makensis.exe" failonerror="true" >
				<arg value="/V3" />
				<arg value="${WIN32.BASE.DIR}\AliwalInstaller.nsi" />
			</exec>
		</target>

<!-- ******************** OSX BUILD **************************************************************** -->	
	<property name="OSX.NAME.ARCH" 	value="${NAME.SHORT}.app" />		
		<property name="OSX.BASE.DIR" 		location="build.osx" />

		<property name="OSX.LIB.DIR"        location="build/osx/lib"            />
			
		<property name="OSX.BUILD.DIR" 		location="build/osx/tmp.build/${OSX.NAME.ARCH}" />
		
		<property name="OSX.RESOURCES" 	location="${OSX.BUILD.DIR}/Contents/Resources"    />
		<property name="OSX.MACOS"	 	location="${OSX.BUILD.DIR}/Contents/MacOS"       />
		<property name="OSX.FRAMEWORKS" location="${OSX.BUILD.DIR}/Contents/Frameworks"  />
		
		<property name="OSX.DIST.DIR"       location="build/osx/dist" />
		<property name="OSX.DIST.MOUNT"     location="${OSX.DIST.DIR}/mnt" />
		<property name="OSX.DIST.TEMPLATE_DMG"   location="${OSX.DIST.DIR}/template.dmg" />
		<property name="OSX.DIST.TMP_DMG"   location="${OSX.DIST.DIR}/temporary.dmg" />
		<property name="OSX.DIST.TARGET"       location="${OSX.DIST.DIR}/${NAME.SHORT}.dmg" />

		
		
		
		<target name="clean_dist_osx" description="Clean up for dist target">
			<delete file="${OSX.DIST.TARGET}"  />
			<delete file="${OSX.DIST.TMP_DMG}"  />
			<exec executable="hdiutil" failonerror="false">
				<arg value="detach" />
				<arg value="${OSX.DIST.MOUNT}" />
			</exec>
			<delete dir="${OSX.DIST.MOUNT}" />
		</target>
			
		<target name="clean_compile_osx" description="Clean up for compile target">
			<delete dir="${OSX.BUILD.DIR}" 	/>
		</target>
			
		<target name="clean_osx" description="clean up" 
			depends="clean_dist_osx,clean_compile_osx">		
		</target>
		
		<target name="init_osx" depends="">
			<!-- Create the time stamp -->
			<tstamp/>
			<mkdir dir="${OSX.BUILD.DIR}"      />					
			<tar tarfile="${OSX.BUILD.DIR}/lib.tar" basedir="${OSX.LIB.DIR}/" longfile="gnu" />
			<untar src="${OSX.BUILD.DIR}/lib.tar"   dest="${OSX.BUILD.DIR}" overwrite="true" />
			<delete file="${OSX.BUILD.DIR}/lib.tar" />
		</target>

		<target name="compile_osx" depends="clean_compile_osx,init_osx"
			description="copy across the application" >
			<mkdir dir="${OSX.RESOURCES}"  />
			<copy todir="${OSX.RESOURCES}" preservelastmodified="true">
				<fileset dir="${SRC.DIR}" >
					<include name="**/*" />
					<exclude name=".DS_Store" />
					<exclude name="**.svn" />
					<exclude name=".project" />
				</fileset>
			</copy>

			<mkdir dir="${OSX.MACOS}"      />
			<copy file="${OSX.LIB.DIR}/Contents/Frameworks/XUL.framework/Versions/Current/xulrunner" 
				todir="${OSX.MACOS}" preservelastmodified="true" />
			<echo>Changing permission of ${OSX.MACOS}/xulrunner</echo>
			<chmod file="${OSX.MACOS}/xulrunner" perm="ugo+rx" verbose="true" />


		</target>
		
		<target name="dist_osx" depends="clean_dist_osx,compile_osx"
			description="generate the distribution" >
			<copy file="${OSX.DIST.TEMPLATE_DMG}" tofile="${OSX.DIST.TMP_DMG}" />

			<exec executable="hdiutil" failonerror="true" >
				<arg value="resize" />
				<arg value="-size" />
				<arg value="120m" />
				<arg value="-growonly" />
				<arg value="-verbose" />
				<arg value="${OSX.DIST.TMP_DMG}" />
			</exec>

			<mkdir dir="${OSX.DIST.MOUNT}" />

			<exec executable="hdiutil" failonerror="true" >
				<arg value="attach" />
				<arg value="${OSX.DIST.TMP_DMG}" />
				<arg value="-noautoopen" />
				<arg value="-verbose" />
				<arg value="-mountpoint" />
				<arg value="${OSX.DIST.MOUNT}" />
			</exec>

			<copy todir="${OSX.DIST.MOUNT}/${OSX.NAME.ARCH}" preservelastmodified="true">
				<fileset dir="${OSX.BUILD.DIR}"/>
			</copy>

			<exec executable="hdiutil" failonerror="true">
				<arg value="detach" />
				<arg value="${OSX.DIST.MOUNT}" />
			</exec>

			<exec executable="hdiutil" failonerror="true">
				<arg value="convert" />
				<arg value="${OSX.DIST.TMP_DMG}" />
				<arg value="-quiet" />
				<arg value="-format" />
				<arg value="UDZO" />
				<arg value="-imagekey" />
				<arg value="zlib-level=9" />
				<arg value="-o" />
				<arg value="${OSX.DIST.TARGET}" />
			</exec>

		</target>

	
	
</project>

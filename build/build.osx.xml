<project name="Aliwal Geocoder OSX Build" default="dist" basedir="../">
	<description>
		simple example build file
	</description>
	
	<property name="NAME.SHORT" 	value="Aliwal Geocoder" />
	<property name="NAME.APP" 		value="${NAME.SHORT}.app" />
	
	<property name="BASE.DIR" 		location="." />
	<property name="SRC.DIR" 		location="application"              />
	<property name="LIB.DIR"        location="build/osx/lib"            />
		
	<property name="BUILD.DIR" 		location="build/osx/tmp.build/${NAME.APP}" />
	
	<property name="OSX.RESOURCES" 	location="${BUILD.DIR}/Contents/Resources"    />
	<property name="OSX.MACOS"	 	location="${BUILD.DIR}/Contents/MacOS"       />
	<property name="OSX.FRAMEWORKS" location="${BUILD.DIR}/Contents/Frameworks"  />
	
	<property name="DIST.DIR"       location="build/osx/dist" />
	<property name="DIST.MOUNT"     location="${DIST.DIR}/mnt" />
	<property name="DIST.TEMPLATE_DMG"   location="${DIST.DIR}/template.dmg" />
	<property name="DIST.TMP_DMG"   location="${DIST.DIR}/temporary.dmg" />
	<property name="DIST.DMG"       location="${DIST.DIR}/${NAME.SHORT}.dmg" />
		
	<target name="clean_dist" description="Clean up for dist target">
		<delete file="${DIST.DMG}"  />
		<delete file="${DIST.TMP_DMG}"  />
		<exec executable="hdiutil" failonerror="false">
			<arg value="detach" />
			<arg value="${DIST.MOUNT}" />
		</exec>
		<delete dir="${DIST.MOUNT}" />
	</target>
		
	<target name="clean_compile" description="Clean up for compile target">
		<delete dir="${BUILD.DIR}" 	/>
	</target>
		
	<target name="clean" description="clean up" 
		depends="clean_dist,clean_compile">		
	</target>
	
	<target name="init" depends="">
		<!-- Create the time stamp -->
		<tstamp/>
		<mkdir dir="${BUILD.DIR}"      />					
		<tar tarfile="${BUILD.DIR}/lib.tar" basedir="${LIB.DIR}/" longfile="gnu" />
		<untar src="${BUILD.DIR}/lib.tar"   dest="${BUILD.DIR}" overwrite="true" />
		<delete file="${BUILD.DIR}/lib.tar" />
	</target>

	<target name="compile" depends="clean_compile,init"
		description="copy across the application" >
		<mkdir dir="${OSX.RESOURCES}"  />
		<copy todir="${OSX.RESOURCES}" preservelastmodified="true">
			<fileset dir="${SRC.DIR}" >
				<include name="**/*" />
				<exclude name=".DS_Store" />
				<exclude name="**.svn" />
				<exclude name=".project" />
			</fileset>
		</copy>

		<mkdir dir="${OSX.MACOS}"      />
		<copy file="${LIB.DIR}/Contents/Frameworks/XUL.framework/Versions/Current/xulrunner" 
			todir="${OSX.MACOS}" preservelastmodified="true" />
		<echo>Changing permission of ${OSX.MACOS}/xulrunner</echo>
		<chmod file="${OSX.MACOS}/xulrunner" perm="ugo+rx" verbose="true" />


	</target>
	
	<target name="dist" depends="clean_dist,compile"
		description="generate the distribution" >
		<copy file="${DIST.TEMPLATE_DMG}" tofile="${DIST.TMP_DMG}" />

		<exec executable="hdiutil" failonerror="true" >
			<arg value="resize" />
			<arg value="-size" />
			<arg value="120m" />
			<arg value="-growonly" />
			<arg value="-verbose" />
			<arg value="${DIST.TMP_DMG}" />
		</exec>

		<mkdir dir="${DIST.MOUNT}" />

		<exec executable="hdiutil" failonerror="true" >
			<arg value="attach" />
			<arg value="${DIST.TMP_DMG}" />
			<arg value="-noautoopen" />
			<arg value="-verbose" />
			<arg value="-mountpoint" />
			<arg value="${DIST.MOUNT}" />
		</exec>

		<copy todir="${DIST.MOUNT}/${NAME.APP}" preservelastmodified="true">
			<fileset dir="${BUILD.DIR}"/>
		</copy>

		<exec executable="hdiutil" failonerror="true">
			<arg value="detach" />
			<arg value="${DIST.MOUNT}" />
		</exec>

		<exec executable="hdiutil" failonerror="true">
			<arg value="convert" />
			<arg value="${DIST.TMP_DMG}" />
			<arg value="-quiet" />
			<arg value="-format" />
			<arg value="UDZO" />
			<arg value="-imagekey" />
			<arg value="zlib-level=9" />
			<arg value="-o" />
			<arg value="${DIST.DMG}" />
		</exec>

	</target>
</project>

